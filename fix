#!/bin/bash

# ç®€åŒ–çš„ä¿®å¤è„šæœ¬
# å¿«é€Ÿä¿®å¤Gité…ç½®ã€æ¨é€ä»£ç å¹¶åˆ›å»ºPR

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# æ£€æŸ¥æ˜¯å¦åœ¨Gitä»“åº“ä¸­
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    log_error "å½“å‰ç›®å½•ä¸æ˜¯Gitä»“åº“"
    exit 1
fi

echo "ğŸš€ å¿«é€Ÿä¿®å¤è„šæœ¬"
echo "=================="

# 1. æ£€æŸ¥å¹¶æ·»åŠ æ‰€æœ‰æ›´æ”¹
if [ -n "$(git status --porcelain)" ]; then
    log_info "å‘ç°æœªæäº¤çš„æ›´æ”¹ï¼Œæ·»åŠ æ‰€æœ‰æ–‡ä»¶..."
    git add .
    
    # ä½¿ç”¨é»˜è®¤æäº¤ä¿¡æ¯æˆ–è¯¢é—®ç”¨æˆ·
    if [ -z "$1" ]; then
        COMMIT_MSG="feat: update project files and configurations"
        log_info "ä½¿ç”¨é»˜è®¤æäº¤ä¿¡æ¯: $COMMIT_MSG"
    else
        COMMIT_MSG="$*"
        log_info "ä½¿ç”¨è‡ªå®šä¹‰æäº¤ä¿¡æ¯: $COMMIT_MSG"
    fi
    
    git commit -m "$COMMIT_MSG"
    log_success "æ›´æ”¹å·²æäº¤"
else
    log_info "æ²¡æœ‰æœªæäº¤çš„æ›´æ”¹"
fi

# 2. è·å–å½“å‰åˆ†æ”¯
CURRENT_BRANCH=$(git branch --show-current)
log_info "å½“å‰åˆ†æ”¯: $CURRENT_BRANCH"

# 3. å°è¯•æ¨é€
log_info "æ¨é€åˆ†æ”¯åˆ°è¿œç¨‹..."
if git push origin "$CURRENT_BRANCH" 2>/dev/null; then
    log_success "æ¨é€æˆåŠŸ"
elif git push -u origin "$CURRENT_BRANCH" 2>/dev/null; then
    log_success "æ¨é€æˆåŠŸï¼ˆè®¾ç½®upstreamï¼‰"
else
    log_warning "æ¨é€å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é…ç½®è®¤è¯"
    echo "è¯·è¿è¡Œå®Œæ•´ä¿®å¤è„šæœ¬: ./fix-git-and-pr.sh"
    exit 1
fi

# 4. æ˜¾ç¤ºçŠ¶æ€
echo ""
log_success "ä¿®å¤å®Œæˆï¼"
echo "å½“å‰çŠ¶æ€:"
git log --oneline -3
echo ""
echo "ğŸ’¡ å¦‚éœ€åˆ›å»ºPRï¼Œè¯·è¿è¡Œ: ./fix-git-and-pr.sh"